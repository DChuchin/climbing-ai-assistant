<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Climbing Coach - –î–º–∏—Ç—Ä–∏–π</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .section-hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        /* Modal - fixed positioning */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .modal-content {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            max-width: 28rem;
            width: calc(100% - 2rem);
            max-height: 90vh;
            overflow-y: auto;
            margin: 1rem;
        }
        
        /* Toast notifications */
        .toast {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
            z-index: 10000;
            animation: slideIn 0.3s ease-out;
        }
        .toast.success { background: #22c55e; color: white; }
        .toast.error { background: #ef4444; color: white; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        /* Markdown content styling */
        .markdown-content h1 { font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem; color: #1f2937; }
        .markdown-content h2 { font-size: 1.25rem; font-weight: 600; margin: 1.5rem 0 0.75rem; color: #374151; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.5rem; }
        .markdown-content h3 { font-size: 1.1rem; font-weight: 600; margin: 1rem 0 0.5rem; color: #374151; }
        .markdown-content h4 { font-size: 1rem; font-weight: 600; margin: 0.75rem 0 0.5rem; color: #4b5563; }
        .markdown-content p { margin-bottom: 0.75rem; color: #4b5563; line-height: 1.6; }
        .markdown-content ul { margin-bottom: 1rem; margin-left: 1.25rem; list-style-type: disc; color: #4b5563; }
        .markdown-content ol { margin-bottom: 1rem; margin-left: 1.25rem; list-style-type: decimal; color: #4b5563; }
        .markdown-content li { margin-bottom: 0.25rem; }
        .markdown-content strong { font-weight: 600; color: #1f2937; }
        .markdown-content code { background: #f3f4f6; padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.875rem; color: #7c3aed; }
        .markdown-content pre { background: #111827; color: #f3f4f6; padding: 1rem; border-radius: 0.75rem; overflow-x: auto; margin-bottom: 1rem; font-size: 0.875rem; }
        .markdown-content pre code { background: transparent; color: #f3f4f6; padding: 0; }
        
        /* Form elements */
        .input-field {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            outline: none;
            transition: all 0.2s;
        }
        .input-field:focus {
            border-color: transparent;
            box-shadow: 0 0 0 2px #a855f7;
        }
        .select-field {
            padding: 0.5rem 0.75rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            outline: none;
            background: white;
        }
        .select-field:focus {
            box-shadow: 0 0 0 2px #a855f7;
        }
        
        /* Buttons */
        .btn-primary {
            background: linear-gradient(to right, #a855f7, #6366f1);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 500;
            transition: all 0.2s;
            border: none;
            cursor: pointer;
        }
        .btn-primary:hover { box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
            padding: 0.5rem 1rem;
            border-radius: 0.75rem;
            font-weight: 500;
            transition: all 0.2s;
            border: none;
            cursor: pointer;
        }
        .btn-secondary:hover { background: #e5e7eb; }
        
        .btn-success {
            background: linear-gradient(to right, #22c55e, #10b981);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.75rem;
            font-weight: 500;
            transition: all 0.2s;
            border: none;
            cursor: pointer;
        }
        .btn-success:hover { box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        
        .btn-danger {
            background: #fee2e2;
            color: #dc2626;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.2s;
            border: none;
            cursor: pointer;
        }
        .btn-danger:hover { background: #fecaca; }
        
        /* Cards */
        .card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
            padding: 1.5rem;
            transition: all 0.3s;
        }
        
        .exercise-card {
            background: #f9fafb;
            border-radius: 0.75rem;
            padding: 1rem;
            border: 1px solid #f3f4f6;
        }
        
        .problem-row {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
            padding: 0.75rem;
            background: white;
            border-radius: 0.75rem;
            border: 1px solid #f3f4f6;
        }
        
        /* Checkbox button */
        .checkbox-btn {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 0.5rem;
            border: 2px solid #d1d5db;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
            color: #d1d5db;
        }
        .checkbox-btn:hover { border-color: #9ca3af; }
        .checkbox-btn.checked {
            background: #22c55e;
            border-color: #22c55e;
            color: white;
        }
        
        /* Metrics */
        .metric-card {
            background: linear-gradient(135deg, #a855f7 0%, #6366f1 100%);
            color: white;
            border-radius: 1rem;
            padding: 1.25rem;
        }
        .stat-value { font-size: 1.875rem; font-weight: bold; }
        .stat-label { font-size: 0.875rem; opacity: 0.8; }
        
        /* Navigation */
        .nav-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.75rem;
            font-weight: 500;
            transition: all 0.2s;
            border: none;
            cursor: pointer;
            white-space: nowrap;
        }
        .nav-btn.active {
            background: white;
            color: #7c3aed;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }
        .nav-btn:not(.active) {
            background: transparent;
            color: rgba(255,255,255,0.8);
        }
        .nav-btn:not(.active):hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }
        
        /* Timer */
        .timer-display {
            font-size: 2.25rem;
            font-family: monospace;
            font-weight: bold;
            text-align: center;
        }
        
        /* Exercises */
        .exercise-link {
            transition: all 0.2s;
        }
        .exercise-card {
            transition: all 0.2s;
        }
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        /* Variations */
        details summary {
            list-style: none;
            user-select: none;
            position: relative;
        }
        details summary::-webkit-details-marker {
            display: none;
        }
        details summary::after {
            content: '‚ñº';
            position: absolute;
            right: 1rem;
            font-size: 0.75rem;
            transition: transform 0.2s;
        }
        details[open] summary::after {
            transform: rotate(180deg);
        }
        details[open] summary {
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="gradient-bg sticky top-0 z-40">
        <div class="max-w-6xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
                        <span class="text-2xl">üßó</span>
                    </div>
                    <div>
                        <h1 class="text-white font-bold text-lg">Climbing Coach</h1>
                        <p class="text-white/70 text-sm" id="athleteName">–î–º–∏—Ç—Ä–∏–π</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <div class="text-right text-white/80 text-sm hidden sm:block">
                        <div id="currentDate"></div>
                        <div id="cycleInfo" class="font-medium text-white"></div>
                    </div>
                    <button onclick="openSettings()" class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center text-white hover:bg-white/30 transition-all">
                        ‚öôÔ∏è
                    </button>
                </div>
            </div>
            
            <!-- Navigation -->
            <nav class="flex gap-2 overflow-x-auto pb-2 -mb-2">
                <button class="nav-btn active" data-section="workout">üèãÔ∏è –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</button>
                <button class="nav-btn" data-section="dashboard">üìä –û–±–∑–æ—Ä</button>
                <button class="nav-btn" data-section="history">üìú –ò—Å—Ç–æ—Ä–∏—è</button>
                <button class="nav-btn" data-section="plan">üìÖ –ü–ª–∞–Ω</button>
                <button class="nav-btn" data-section="exercises">üí™ –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</button>
                <button class="nav-btn" data-section="nutrition">ü•ó –ü–∏—Ç–∞–Ω–∏–µ</button>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-6xl mx-auto px-4 py-6">
        
        <!-- Workout Section (Active Training) -->
        <section id="section-workout" class="fade-in">

            <!-- Today's Workout Header -->
            <div class="card mb-6">
                <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
                    <div class="flex items-center gap-3">
                        <span class="text-3xl" id="dayIcon">üéØ</span>
                        <div>
                            <div class="text-sm text-gray-500" id="workoutDate">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                            <h2 class="text-xl font-bold text-gray-800" id="workoutTitle">–î–µ–Ω—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</h2>
                        </div>
                    </div>
                </div>

                <!-- Pre-workout metrics -->
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                    <div>
                        <label class="text-sm text-gray-500 block mb-1">–°–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ</label>
                        <select id="preFeeling" class="select-field w-full">
                            <option value="">‚Äî</option>
                            <option value="5">5 - –ü–ª–æ—Ö–æ</option>
                            <option value="6">6 - –ù–æ—Ä–º–∞–ª—å–Ω–æ</option>
                            <option value="7">7 - –•–æ—Ä–æ—à–æ</option>
                            <option value="8">8 - –û—Ç–ª–∏—á–Ω–æ</option>
                            <option value="9">9 - –°—É–ø–µ—Ä</option>
                            <option value="10">10 - –ò–¥–µ–∞–ª—å–Ω–æ</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-sm text-gray-500 block mb-1">–°–æ–Ω (—á–∞—Å–æ–≤)</label>
                        <input type="number" id="sleepHours" class="input-field" placeholder="7.5" step="0.5" min="4" max="12">
                    </div>
                    <div>
                        <label class="text-sm text-gray-500 block mb-1">–ö–∞—á–µ—Å—Ç–≤–æ —Å–Ω–∞</label>
                        <select id="sleepQuality" class="select-field w-full">
                            <option value="">‚Äî</option>
                            <option value="5">5 - –ü–ª–æ—Ö–æ–π</option>
                            <option value="6">6 - –ù–æ—Ä–º–∞–ª—å–Ω—ã–π</option>
                            <option value="7">7 - –•–æ—Ä–æ—à–∏–π</option>
                            <option value="8">8 - –û—Ç–ª–∏—á–Ω—ã–π</option>
                            <option value="9">9 - –ò–¥–µ–∞–ª—å–Ω—ã–π</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-sm text-gray-500 block mb-1">–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞</label>
                        <input type="time" id="startTime" class="input-field">
                    </div>
                </div>
            </div>

            <!-- Rest Timer -->
            <div class="card mb-6" style="background: linear-gradient(to right, #eef2ff, #faf5ff); border: 1px solid #c7d2fe;">
                <div class="flex flex-wrap items-center justify-between gap-4">
                    <div class="flex items-center gap-4">
                        <span class="text-2xl">‚è±Ô∏è</span>
                        <div>
                            <div class="text-sm font-medium" style="color: #4f46e5;">–¢–∞–π–º–µ—Ä –æ—Ç–¥—ã—Ö–∞</div>
                            <div class="timer-display" style="color: #4338ca;" id="timerDisplay">4:00</div>
                        </div>
                    </div>
                    <div class="flex gap-2 flex-wrap">
                        <button onclick="setTimer(180)" class="btn-secondary">3 –º–∏–Ω</button>
                        <button onclick="setTimer(240)" class="btn-secondary">4 –º–∏–Ω</button>
                        <button onclick="setTimer(300)" class="btn-secondary">5 –º–∏–Ω</button>
                        <button onclick="toggleTimer()" id="timerBtn" class="btn-primary">‚ñ∂ –°—Ç–∞—Ä—Ç</button>
                    </div>
                </div>
            </div>

            <!-- Today's Plan with Checkboxes -->
            <div class="card mb-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-2">
                        <span class="text-2xl">üìã</span>
                        <h3 class="text-lg font-bold text-gray-800">–ü–ª–∞–Ω –Ω–∞ —Å–µ–≥–æ–¥–Ω—è</h3>
                    </div>
                    <div id="planProgress" class="text-sm text-gray-500">0 / 0 –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</div>
                </div>
                
                <div id="todayPlanBlocks" class="space-y-3">
                    <p class="text-gray-500 text-center py-4">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–ª–∞–Ω–∞...</p>
                </div>
            </div>

            <!-- Climbing Problems -->
            <div class="card mb-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-2">
                        <span class="text-2xl">üßó</span>
                        <h3 class="text-lg font-bold text-gray-800">–ë–æ–ª–¥–µ—Ä–∏–Ω–≥ (—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã)</h3>
                    </div>
                    <button onclick="addProblem()" class="btn-secondary">+ –ü—Ä–æ–±–ª–µ–º–∞</button>
                </div>
                
                <div id="problemsList" class="space-y-2">
                    <!-- Problems will be added here -->
                </div>
                
                <div class="mt-4 p-3 bg-gray-50 rounded-xl text-sm text-gray-600">
                    <span id="problemsStats">–ü—Ä–æ–ª–µ–∑–µ–Ω–æ: 0 | –í—Å–µ–≥–æ: 0 | –§–ª–µ—à: 0%</span>
                </div>
            </div>

            <!-- Additional Exercises (not in plan) -->
            <div class="card mb-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-2">
                        <span class="text-2xl">‚ûï</span>
                        <h3 class="text-lg font-bold text-gray-800">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ (–≤–Ω–µ –ø–ª–∞–Ω–∞)</h3>
                    </div>
                    <button onclick="addExercise()" class="btn-secondary">+ –£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</button>
                </div>
                
                <div id="exercisesList" class="space-y-3">
                    <p class="text-gray-400 text-sm text-center py-2">–î–æ–±–∞–≤—å—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ –±—ã–ª–æ –≤ –ø–ª–∞–Ω–µ</p>
                </div>
            </div>

            <!-- Workout Summary -->
            <div class="card mb-6">
                <div class="flex items-center gap-2 mb-4">
                    <span class="text-2xl">üìù</span>
                    <h3 class="text-lg font-bold text-gray-800">–ò—Ç–æ–≥–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</h3>
                </div>
                
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="text-sm text-gray-500 block mb-1">RPE (–Ω–∞–≥—Ä—É–∑–∫–∞)</label>
                        <select id="workoutRPE" class="select-field w-full">
                            <option value="">‚Äî</option>
                            <option value="5">5 - –õ–µ–≥–∫–æ</option>
                            <option value="6">6 - –£–º–µ—Ä–µ–Ω–Ω–æ</option>
                            <option value="7">7 - –°—Ä–µ–¥–Ω–µ</option>
                            <option value="8">8 - –¢—è–∂–µ–ª–æ</option>
                            <option value="9">9 - –û—á–µ–Ω—å —Ç—è–∂–µ–ª–æ</option>
                            <option value="10">10 - –ú–∞–∫—Å–∏–º—É–º</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-sm text-gray-500 block mb-1">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–º–∏–Ω)</label>
                        <input type="number" id="workoutDuration" class="input-field" placeholder="90">
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="text-sm text-gray-500 block mb-1">–ó–∞–º–µ—Ç–∫–∏</label>
                    <textarea id="workoutNotes" class="input-field h-24 resize-none" placeholder="–ß—Ç–æ –ø–æ–ª—É—á–∏–ª–æ—Å—å —Ö–æ—Ä–æ—à–æ? –ß—Ç–æ –±—ã–ª–æ —Å–ª–æ–∂–Ω–æ? –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –Ω–∞—Ö–æ–¥–∫–∏..."></textarea>
                </div>
                
                <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 text-sm text-blue-800">
                    <div class="font-medium mb-1">‚ÑπÔ∏è –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –¥–Ω–µ–≤–Ω–∏–∫ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</div>
                    <div class="text-xs text-blue-600">
                        –≠—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–º–æ–≥–∞–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–ª–∞–Ω–∞ –≤–æ –≤—Ä–µ–º—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏.
                        –ò—Å—Ç–æ—Ä–∏—è –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∏–∑ <code class="bg-blue-100 px-1 rounded">progress_log.md</code>
                    </div>
                </div>
                
                <button onclick="clearWorkout()" class="btn-secondary w-full">
                    üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å —á–µ–∫–ª–∏—Å—Ç
                </button>
            </div>
        </section>

        <!-- Dashboard Section -->
        <section id="section-dashboard" class="section-hidden">
            <!-- Cycle & Recovery Info -->
            <div class="card mb-6">
                <div class="flex flex-wrap items-center justify-between gap-4">
                    <div>
                        <div class="text-sm text-gray-500">–ú–µ–∑–æ—Ü–∏–∫–ª</div>
                        <div class="font-bold text-gray-800" id="mesocycleName">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                        <div class="text-sm text-gray-600" id="currentWeek">‚Äî</div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm text-gray-500">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ</div>
                        <div class="text-2xl font-bold" id="recoveryStatus">‚Äî</div>
                    </div>
                </div>
            </div>
            
            <!-- Quick Stats -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="metric-card">
                    <div class="stat-value" id="currentGrade">6C</div>
                    <div class="stat-label">–¢–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å</div>
                </div>
                <div class="metric-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <div class="stat-value" id="hangTime">7—Å</div>
                    <div class="stat-label">–í–∏—Å 20–º–º</div>
                </div>
                <div class="metric-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                    <div class="stat-value" id="pullupWeight">+40–∫–≥</div>
                    <div class="stat-label">–ü–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è</div>
                </div>
                <div class="metric-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                    <div class="stat-value" id="totalSessions">0</div>
                    <div class="stat-label">–¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</div>
                </div>
            </div>

            <!-- Recent Sessions -->
            <div class="card mb-6">
                <div class="flex items-center gap-2 mb-4">
                    <span class="text-2xl">üìù</span>
                    <h2 class="text-xl font-bold text-gray-800">–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</h2>
                </div>
                <div id="recentSessions" class="space-y-3">
                    <p class="text-gray-500 text-center py-4">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                </div>
            </div>

            <!-- Priorities -->
            <div class="card">
                <div class="flex items-center gap-2 mb-4">
                    <span class="text-2xl">üéØ</span>
                    <h2 class="text-xl font-bold text-gray-800">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã —Ä–∞–∑–≤–∏—Ç–∏—è</h2>
                </div>
                <div class="grid md:grid-cols-3 gap-4">
                    <div class="p-4 bg-red-50 rounded-xl border border-red-100">
                        <div class="text-red-600 font-semibold mb-2">üéØ –ö—Ä–∏—Ç–∏—á–Ω–æ</div>
                        <ul class="text-gray-700 text-sm space-y-1">
                            <li>‚Ä¢ –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ —Å–∏–ª—ã –ø–∞–ª—å—Ü–µ–≤</li>
                            <li>‚Ä¢ –£–∫—Ä–µ–ø–ª–µ–Ω–∏–µ –∫–æ—Ä–∞</li>
                        </ul>
                    </div>
                    <div class="p-4 bg-yellow-50 rounded-xl border border-yellow-100">
                        <div class="text-yellow-600 font-semibold mb-2">‚ö° –í–∞–∂–Ω–æ</div>
                        <ul class="text-gray-700 text-sm space-y-1">
                            <li>‚Ä¢ –¢–µ—Ö–Ω–∏–∫–∞ –Ω–∞ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏</li>
                            <li>‚Ä¢ –†–∞–±–æ—Ç–∞ —Å –º–µ–ª–∫–∏–º–∏ –∑–∞—Ü–µ–ø–∫–∞–º–∏</li>
                        </ul>
                    </div>
                    <div class="p-4 bg-green-50 rounded-xl border border-green-100">
                        <div class="text-green-600 font-semibold mb-2">‚úì –ü–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ</div>
                        <ul class="text-gray-700 text-sm space-y-1">
                            <li>‚Ä¢ –°–∏–ª–∞ –≤–µ—Ä—Ö–Ω–µ–≥–æ –ø–ª–µ—á–µ–≤–æ–≥–æ –ø–æ—è—Å–∞</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>

        <!-- History Section -->
        <section id="section-history" class="section-hidden">
            <div class="card">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-2">
                        <span class="text-2xl">üìú</span>
                        <h2 class="text-xl font-bold text-gray-800">–ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</h2>
                    </div>
                    <button onclick="loadHistory()" class="btn-secondary">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
                </div>
                <div id="historyList" class="space-y-4">
                    <p class="text-gray-500 text-center py-8">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...</p>
                </div>
            </div>
        </section>

        <!-- Plan Section -->
        <section id="section-plan" class="section-hidden">
            <div class="card">
                <div class="flex items-center gap-2 mb-4">
                    <span class="text-2xl">üìÖ</span>
                    <h2 class="text-xl font-bold text-gray-800">–¢—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—ã–π –ø–ª–∞–Ω</h2>
                </div>
                <div id="planContent" class="markdown-content">
                    <p class="text-gray-500 text-center py-8">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–ª–∞–Ω–∞...</p>
                </div>
            </div>
        </section>

        <!-- Nutrition Section -->
        <section id="section-exercises" class="section-hidden">
            <div class="card mb-4">
                <div class="flex items-center gap-2 mb-4">
                    <span class="text-2xl">üí™</span>
                    <h2 class="text-xl font-bold text-gray-800">–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π</h2>
                </div>
                
                <!-- Search -->
                <div class="mb-4">
                    <input type="text" id="exerciseSearch" placeholder="üîç –ü–æ–∏—Å–∫ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è..." 
                        class="input-field" onkeyup="filterExercises()">
                </div>
                
                <!-- Categories -->
                <div id="exerciseCategories" class="space-y-6">
                    <p class="text-gray-500 text-center py-8">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                </div>
            </div>
        </section>
        
        <section id="section-nutrition" class="section-hidden">
            <div class="card">
                <div class="flex items-center gap-2 mb-4">
                    <span class="text-2xl">ü•ó</span>
                    <h2 class="text-xl font-bold text-gray-800">–ü–∏—Ç–∞–Ω–∏–µ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ</h2>
                </div>
                <div id="nutritionContent" class="markdown-content">
                    <p class="text-gray-500 text-center py-8">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                </div>
            </div>
        </section>

    </main>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal-overlay section-hidden">
        <div class="modal-content">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-800">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
                <button onclick="closeSettings()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="text-sm text-gray-600 block mb-1">GitHub Personal Access Token</label>
                    <input type="password" id="githubToken" class="input-field" placeholder="ghp_xxxxxxxxxxxx">
                    <p class="text-xs text-gray-400 mt-1">–ù—É–∂–Ω—ã –ø—Ä–∞–≤–∞: gist (read/write)</p>
                </div>
                
                <div>
                    <label class="text-sm text-gray-600 block mb-1">Gist ID</label>
                    <input type="text" id="gistId" class="input-field" placeholder="abc123...">
                    <p class="text-xs text-gray-400 mt-1">ID —Å–µ–∫—Ä–µ—Ç–Ω–æ–≥–æ Gist –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö</p>
                </div>
                
                <div class="pt-2">
                    <button onclick="createNewGist()" class="btn-secondary w-full mb-2">
                        üìù –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π Gist
                    </button>
                    <button onclick="testConnection()" class="btn-primary w-full">
                        üîó –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
                    </button>
                </div>
                
                <div id="connectionResult" class="hidden p-3 rounded-xl text-sm"></div>
                
                <hr class="my-4">
                
                <div>
                    <button onclick="exportData()" class="btn-secondary w-full mb-2">
                        üì§ –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö (JSON)
                    </button>
                    <button onclick="saveSettings()" class="btn-success w-full">
                        üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Plan Modal -->
    <div id="planModal" class="modal-overlay section-hidden">
        <div class="modal-content" style="max-width: 42rem;">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-800">üìã –ü–ª–∞–Ω –Ω–∞ —Å–µ–≥–æ–¥–Ω—è</h3>
                <button onclick="closePlanModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            <div id="todayPlanContent" class="markdown-content">
                –ó–∞–≥—Ä—É–∑–∫–∞...
            </div>
        </div>
    </div>

    <!-- Exercise Detail Modal -->
    <div id="exerciseModal" class="modal-overlay section-hidden" onclick="closeExerciseModal(event)">
        <div class="modal-content" style="max-width: 48rem;" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-800" id="exerciseModalTitle">üí™ –£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</h3>
                <button onclick="closeExerciseModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            <div id="exerciseModalContent" class="markdown-content">
                –ó–∞–≥—Ä—É–∑–∫–∞...
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer"></div>

    <script>
        // ==================== STATE ====================
        let workoutData = {
            problems: [],
            exercises: []
        };
        
        let timerInterval = null;
        let timerSeconds = 240;
        let timerRunning = false;
        
        let trainingPlan = null;
        let nutritionRecovery = null;
        let exercisesLibrary = null;
        let progressLog = null;
        let exercisesData = {};  // Parsed exercises with anchors
        let progressSessions = [];  // Parsed training sessions from progress_log.md
        let currentState = null;  // –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã –¥–ª—è week_plan
        let gistData = { sessions: [] };

        // Day configuration
        // Day config based on –°—Ö–µ–º–∞ –ë (–ü–ù-–í–¢ —Ä–∞–±–æ—Ç–∞, –°–†-–ß–¢ –æ—Ç–¥—ã—Ö, –ü–¢-–°–ë —Ä–∞–±–æ—Ç–∞, –í–° –æ—Ç–¥—ã—Ö)
        const dayConfig = {
            0: { name: '–ü–æ–ª–Ω—ã–π –æ—Ç–¥—ã—Ö', icon: '‚ö™', type: 'rest' },
            1: { name: '–°–∏–ª–∞ –ø–∞–ª—å—Ü–µ–≤ + –ö–æ—Ä', icon: 'üí™', type: 'strength' },
            2: { name: '–¢–µ—Ö–Ω–∏–∫–∞ + –û–±—ä—ë–º', icon: 'üéØ', type: 'technique' },
            3: { name: '–ê–∫—Ç–∏–≤–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ', icon: 'üßò', type: 'recovery' },
            4: { name: '–ê–∫—Ç–∏–≤–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ', icon: 'üßò', type: 'recovery' },
            5: { name: '–ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å + –ü—Ä–æ–µ–∫—Ç—ã', icon: '‚ö°', type: 'intensity' },
            6: { name: '–û–±—ä—ë–º + –í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å', icon: 'üìä', type: 'volume' }
        };

        const dayNames = ['–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ', '–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–í—Ç–æ—Ä–Ω–∏–∫', '–°—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä–≥', '–ü—è—Ç–Ω–∏—Ü–∞', '–°—É–±–±–æ—Ç–∞'];
        const dayKeys = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
        const dayLabels = {
            monday: '–ü–ù', tuesday: '–í–¢', wednesday: '–°–†', 
            thursday: '–ß–¢', friday: '–ü–¢', saturday: '–°–ë', sunday: '–í–°'
        };
        const grades = ['5A', '5B', '5C', '6A', '6A+', '6B', '6B+', '6C', '6C+', '7A', '7A+', '7B', '7B+', '7C'];
        
        // Currently selected day for viewing (null = today)
        let selectedDayKey = null;

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', async () => {
            setupNavigation();
            loadSettings();
            
            // Load files first (includes current_state.json)
            await loadMarkdownFiles();
            
            // Now update UI with loaded data
            updateDateTime();  // Uses currentState.today_plan if available
            renderTodayPlanBlocks();  // Render plan from current_state.json
            renderDashboard();  // Update dashboard with currentState data
            
            // await loadGistData();  // Disabled: using progress_log.md now
            // updateConnectionStatus();
            
            // Add default exercises based on day
            setupDefaultExercises();
        });

        function updateDateTime() {
            const now = new Date();
            const dayOfWeek = now.getDay();
            const todayDayKey = dayKeys[dayOfWeek];
            
            document.getElementById('currentDate').textContent = now.toLocaleDateString('ru-RU', { 
                weekday: 'long', day: 'numeric', month: 'long' 
            });
            
            // Use week_plan if available (–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã)
            const weekPlan = currentState?.week_plan;
            if (weekPlan?.days?.[todayDayKey]) {
                const plan = weekPlan.days[todayDayKey];
                document.getElementById('workoutTitle').textContent = plan.type;
                document.getElementById('dayIcon').textContent = plan.emoji || 'üìã';
                document.getElementById('workoutDate').textContent = plan.date || `${dayNames[dayOfWeek]}, ${now.toLocaleDateString('ru-RU')}`;
                
                // Update cycle info
                const cycle = currentState.training_cycle;
                if (cycle) {
                    document.getElementById('cycleInfo').textContent = 
                        `–ù–µ–¥–µ–ª—è ${cycle.current_week}/${cycle.mesocycle_length_weeks}`;
                }
            } else {
                // Fallback to dayConfig
                const config = dayConfig[dayOfWeek];
                document.getElementById('workoutTitle').textContent = config.name;
                document.getElementById('dayIcon').textContent = config.icon;
                document.getElementById('workoutDate').textContent = `${dayNames[dayOfWeek]}, ${now.toLocaleDateString('ru-RU')}`;
            }
            
            // Set default start time
            document.getElementById('startTime').value = now.toTimeString().slice(0, 5);
        }

        function setupNavigation() {
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const section = btn.dataset.section;
                    switchSection(section);
                    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                });
            });
        }

        function switchSection(sectionId) {
            document.querySelectorAll('main > section').forEach(s => s.classList.add('section-hidden'));
            const section = document.getElementById(`section-${sectionId}`);
            if (section) {
                section.classList.remove('section-hidden');
                section.classList.add('fade-in');
            }
            
            // Load content
            if (sectionId === 'plan' && trainingPlan) {
                document.getElementById('planContent').innerHTML = marked.parse(trainingPlan);
            } else if (sectionId === 'nutrition' && nutritionRecovery) {
                document.getElementById('nutritionContent').innerHTML = marked.parse(nutritionRecovery);
            } else if (sectionId === 'history') {
                renderHistory();
            } else if (sectionId === 'dashboard') {
                renderDashboard();
            }
        }

        async function loadMarkdownFiles() {
            console.log('Loading files...');
            try {
                const [planRes, nutritionRes, exercisesRes, progressRes, stateRes] = await Promise.all([
                    fetch('training_plan.md'),
                    fetch('nutrition_recovery.md'),
                    fetch('exercises_library.md'),
                    fetch('progress_log.md'),
                    fetch('current_state.json')
                ]);
                
                if (planRes.ok) {
                    trainingPlan = await planRes.text();
                    console.log('Training plan loaded, length:', trainingPlan.length);
                } else {
                    console.error('Failed to load training_plan.md:', planRes.status);
                }
                
                if (nutritionRes.ok) {
                    nutritionRecovery = await nutritionRes.text();
                    console.log('Nutrition loaded, length:', nutritionRecovery.length);
                } else {
                    console.error('Failed to load nutrition_recovery.md:', nutritionRes.status);
                }
                
                if (exercisesRes.ok) {
                    exercisesLibrary = await exercisesRes.text();
                    console.log('Exercises library loaded, length:', exercisesLibrary.length);
                    parseExercisesLibrary();
                } else {
                    console.error('Failed to load exercises_library.md:', exercisesRes.status);
                }
                
                if (progressRes.ok) {
                    progressLog = await progressRes.text();
                    console.log('Progress log loaded, length:', progressLog.length);
                    parseProgressLog();
                } else {
                    console.error('Failed to load progress_log.md:', progressRes.status);
                }
                
                if (stateRes.ok) {
                    currentState = await stateRes.json();
                    console.log('Current state loaded:', currentState?.week_plan ? 'week_plan found' : 'no week_plan');
                } else {
                    console.error('Failed to load current_state.json:', stateRes.status);
                }
            } catch (e) {
                console.error('Error loading files:', e);
            }
        }

        // ==================== EXERCISES LIBRARY ====================
        function makeExerciseClickable(text) {
            if (!exercisesData.categories) return text;
            
            let result = text;
            
            // Build list of all exercise names (sorted by length, longest first)
            const allExercises = [];
            exercisesData.categories.forEach(cat => {
                cat.exercises.forEach(ex => {
                    // Store both original name and name without parentheses
                    const nameWithoutParens = ex.name.replace(/\s*\([^)]*\)/g, '').trim();
                    allExercises.push({ 
                        name: ex.name, 
                        nameAlt: nameWithoutParens,
                        id: ex.id 
                    });
                });
            });
            
            // Sort by length (longest first to match longer names first)
            allExercises.sort((a, b) => {
                const lenA = Math.max(a.name.length, a.nameAlt.length);
                const lenB = Math.max(b.name.length, b.nameAlt.length);
                return lenB - lenA;
            });
            
            // Extract exercise name from plan text (before colon or dash)
            const textBeforeParams = text.split(/[:‚Äì‚Äî]/)[0].trim();
            
            // Try to find matching exercise
            for (const ex of allExercises) {
                // Try exact match with original name
                if (textBeforeParams.toLowerCase().includes(ex.name.toLowerCase())) {
                    const escapedName = ex.name.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                    const regex = new RegExp(`(${escapedName})`, 'gi');
                    result = result.replace(regex, 
                        `<span class="exercise-link text-purple-600 hover:text-purple-800 cursor-pointer underline" onclick="showExerciseDetail('${ex.id}')">$1</span>`
                    );
                    break;
                }
                // Try match without parentheses
                else if (ex.nameAlt !== ex.name && textBeforeParams.toLowerCase().includes(ex.nameAlt.toLowerCase())) {
                    const escapedName = ex.nameAlt.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                    const regex = new RegExp(`(${escapedName})`, 'gi');
                    result = result.replace(regex, 
                        `<span class="exercise-link text-purple-600 hover:text-purple-800 cursor-pointer underline" onclick="showExerciseDetail('${ex.id}')">$1</span>`
                    );
                    break;
                }
                // Try partial match at the start
                else if (textBeforeParams.toLowerCase().startsWith(ex.nameAlt.toLowerCase().substring(0, Math.min(10, ex.nameAlt.length)))) {
                    // Find the actual matching part
                    const words = ex.nameAlt.split(' ');
                    let matchedPart = '';
                    for (let i = words.length; i > 0; i--) {
                        const testPhrase = words.slice(0, i).join(' ');
                        if (textBeforeParams.toLowerCase().includes(testPhrase.toLowerCase())) {
                            matchedPart = testPhrase;
                            break;
                        }
                    }
                    if (matchedPart.length >= 5) {
                        const escapedName = matchedPart.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                        const regex = new RegExp(`(${escapedName})`, 'gi');
                        result = result.replace(regex, 
                            `<span class="exercise-link text-purple-600 hover:text-purple-800 cursor-pointer underline" onclick="showExerciseDetail('${ex.id}')">$1</span>`
                        );
                        break;
                    }
                }
            }
            
            return result;
        }
        
        function parseExercisesLibrary() {
            if (!exercisesLibrary) return;
            
            exercisesData = { categories: [] };
            let currentCategory = null;
            let currentExercise = null;
            
            const lines = exercisesLibrary.split('\n');
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                
                // Category (## CATEGORY)
                if (line.match(/^## [–ê-–Ø–ÅA-Z]/)) {
                    if (currentExercise && currentCategory) {
                        currentCategory.exercises.push(currentExercise);
                    }
                    currentExercise = null;
                    
                    currentCategory = {
                        name: line.replace(/^## /, '').trim(),
                        id: line.replace(/^## /, '').toLowerCase().replace(/[^\w\s-]/g, '').replace(/\s+/g, '-'),
                        exercises: []
                    };
                    exercisesData.categories.push(currentCategory);
                }
                // Exercise (### Exercise Name)
                else if (line.startsWith('### ')) {
                    if (currentExercise && currentCategory) {
                        currentCategory.exercises.push(currentExercise);
                    }
                    
                    const exerciseName = line.replace(/^### /, '').trim();
                    currentExercise = {
                        name: exerciseName,
                        id: exerciseName.toLowerCase().replace(/[^\w\s-]/g, '').replace(/\s+/g, '-'),
                        content: line + '\n',
                        description: '',
                        technique: '',
                        mistakes: ''
                    };
                }
                // Collect exercise content
                else if (currentExercise) {
                    currentExercise.content += line + '\n';
                    
                    // Extract key sections
                    if (line.startsWith('**–û–ø–∏—Å–∞–Ω–∏–µ:**')) {
                        currentExercise.description = lines[i + 1] || '';
                    }
                }
            }
            
            // Add last exercise
            if (currentExercise && currentCategory) {
                currentCategory.exercises.push(currentExercise);
            }
            
            console.log('Parsed exercises:', exercisesData.categories.length, 'categories');
            renderExercisesLibrary();
        }
        
        function renderExercisesLibrary() {
            const container = document.getElementById('exerciseCategories');
            if (!exercisesData.categories || exercisesData.categories.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞</p>';
                return;
            }
            
            let html = '';
            exercisesData.categories.forEach(category => {
                html += `
                    <div class="exercise-category" data-category="${category.id}">
                        <h3 class="text-lg font-bold text-gray-800 mb-3">${category.name}</h3>
                        <div class="grid md:grid-cols-2 gap-3">
                            ${category.exercises.map(ex => `
                                <button onclick="showExerciseDetail('${ex.id}')" 
                                    class="exercise-card p-3 text-left bg-gray-50 hover:bg-purple-50 rounded-xl border border-gray-200 hover:border-purple-300 transition-all"
                                    data-exercise="${ex.id}"
                                    data-name="${ex.name.toLowerCase()}">
                                    <div class="font-medium text-gray-800">${ex.name}</div>
                                    ${ex.description ? `<div class="text-xs text-gray-500 mt-1 line-clamp-2">${ex.description}</div>` : ''}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function showExerciseDetail(exerciseId) {
            let exercise = null;
            
            // Find exercise by ID
            for (const category of exercisesData.categories) {
                exercise = category.exercises.find(ex => ex.id === exerciseId);
                if (exercise) break;
            }
            
            if (!exercise) {
                console.error('Exercise not found:', exerciseId);
                return;
            }
            
            const modal = document.getElementById('exerciseModal');
            const titleEl = document.getElementById('exerciseModalTitle');
            const contentEl = document.getElementById('exerciseModalContent');
            
            titleEl.textContent = exercise.name;
            contentEl.innerHTML = marked.parse(exercise.content);
            
            modal.classList.remove('section-hidden');
        }
        
        function closeExerciseModal(event) {
            // Close on backdrop click or explicit close
            if (!event || event.target.id === 'exerciseModal') {
                document.getElementById('exerciseModal').classList.add('section-hidden');
            }
        }
        
        // ==================== PROGRESS LOG PARSER ====================
        function parseProgressLog() {
            if (!progressLog) return;
            
            progressSessions = [];
            const lines = progressLog.split('\n');
            let currentSession = null;
            let currentSection = '';
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                
                // Detect new session (### üìÖ or ####)
                if (line.match(/^###\s*üìÖ/) || line.match(/^####\s+\d{1,2}\s+(—è–Ω–≤–∞—Ä—è|—Ñ–µ–≤—Ä–∞–ª—è|–º–∞—Ä—Ç–∞|–∞–ø—Ä–µ–ª—è|–º–∞—è|–∏—é–Ω—è|–∏—é–ª—è|–∞–≤–≥—É—Å—Ç–∞|—Å–µ–Ω—Ç—è–±—Ä—è|–æ–∫—Ç—è–±—Ä—è|–Ω–æ—è–±—Ä—è|–¥–µ–∫–∞–±—Ä—è)\s+\d{4}/i)) {
                    // Save previous session
                    if (currentSession && currentSession.date) {
                        progressSessions.push(currentSession);
                    }
                    
                    // Parse date from header
                    let dateStr = '';
                    let typeStr = '';
                    
                    if (line.includes('üìÖ')) {
                        // Format: ### üìÖ –°–†–ï–î–ê, 4 –§–ï–í–†–ê–õ–Ø 2026
                        const match = line.match(/üìÖ\s+([–ê-–Ø–∞-—è]+),?\s+(\d{1,2})\s+([–ê-–Ø–∞-—è]+)\s+(\d{4})/);
                        if (match) {
                            const monthMap = {
                                '—è–Ω–≤–∞—Ä—è': '01', '—Ñ–µ–≤—Ä–∞–ª—è': '02', '–º–∞—Ä—Ç–∞': '03', '–∞–ø—Ä–µ–ª—è': '04',
                                '–º–∞—è': '05', '–∏—é–Ω—è': '06', '–∏—é–ª—è': '07', '–∞–≤–≥—É—Å—Ç–∞': '08',
                                '—Å–µ–Ω—Ç—è–±—Ä—è': '09', '–æ–∫—Ç—è–±—Ä—è': '10', '–Ω–æ—è–±—Ä—è': '11', '–¥–µ–∫–∞–±—Ä—è': '12'
                            };
                            const day = match[2].padStart(2, '0');
                            const month = monthMap[match[3].toLowerCase()];
                            const year = match[4];
                            dateStr = `${year}-${month}-${day}`;
                        }
                    } else {
                        // Format: #### 23 —è–Ω–≤–∞—Ä—è 2026 (–ß–µ—Ç–≤–µ—Ä–≥) - –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï
                        const match = line.match(/####\s+(\d{1,2})\s+([–∞-—è]+)\s+(\d{4})/i);
                        if (match) {
                            const monthMap = {
                                '—è–Ω–≤–∞—Ä—è': '01', '—Ñ–µ–≤—Ä–∞–ª—è': '02', '–º–∞—Ä—Ç–∞': '03', '–∞–ø—Ä–µ–ª—è': '04',
                                '–º–∞—è': '05', '–∏—é–Ω—è': '06', '–∏—é–ª—è': '07', '–∞–≤–≥—É—Å—Ç–∞': '08',
                                '—Å–µ–Ω—Ç—è–±—Ä—è': '09', '–æ–∫—Ç—è–±—Ä—è': '10', '–Ω–æ—è–±—Ä—è': '11', '–¥–µ–∫–∞–±—Ä—è': '12'
                            };
                            const day = match[1].padStart(2, '0');
                            const month = monthMap[match[2].toLowerCase()];
                            const year = match[3];
                            dateStr = `${year}-${month}-${day}`;
                        }
                        // Extract type from header
                        const typeMatch = line.match(/-\s+([–ê-–Ø–Å\s]+)$/);
                        if (typeMatch) {
                            typeStr = typeMatch[1].trim();
                        }
                    }
                    
                    currentSession = {
                        date: dateStr,
                        type: typeStr,
                        feeling: '',
                        sleep: '',
                        recovery: '',
                        weight: '',
                        work: [],
                        rpe: '',
                        duration: '',
                        notes: []
                    };
                    currentSection = '';
                    continue;
                }
                
                if (!currentSession) continue;
                
                // Parse session fields
                if (line.match(/^\*\*–ü–ª–∞–Ω:\*\*/)) {
                    currentSession.type = line.replace(/^\*\*–ü–ª–∞–Ω:\*\*\s*/, '').trim();
                } else if (line.match(/^\*\*–í—ã–ø–æ–ª–Ω–µ–Ω–æ:\*\*/)) {
                    currentSession.duration = line.replace(/^\*\*–í—ã–ø–æ–ª–Ω–µ–Ω–æ:\*\*\s*/, '').replace(/‚úÖ/g, '').trim();
                } else if (line.match(/^\*\*RPE:\*\*/)) {
                    currentSession.rpe = line.replace(/^\*\*RPE:\*\*\s*/, '').trim();
                } else if (line.match(/^\*\*–ú–µ—Å—Ç–æ:\*\*/)) {
                    // skip
                } else if (line.match(/^\*\*–í—Ä–µ–º—è:\*\*/)) {
                    const timeStr = line.replace(/^\*\*–í—Ä–µ–º—è:\*\*\s*/, '').trim();
                    if (!currentSession.duration) {
                        currentSession.duration = timeStr;
                    }
                } else if (line.match(/^-\s*\*\*–°–æ–Ω:\*\*/)) {
                    currentSession.sleep = line.replace(/^-\s*\*\*–°–æ–Ω:\*\*\s*/, '').trim();
                } else if (line.match(/^\*\*–°–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ –ø–µ—Ä–µ–¥ —Ç—Ä–µ–Ω–µ–π:\*\*/)) {
                    currentSession.feeling = line.replace(/^\*\*–°–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ –ø–µ—Ä–µ–¥ —Ç—Ä–µ–Ω–µ–π:\*\*\s*/, '').trim();
                } else if (line.match(/^-\s*\*\*–û–±—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:\*\*/)) {
                    currentSession.feeling = line.replace(/^-\s*\*\*–û–±—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:\*\*\s*/, '').trim();
                } else if (line.match(/^\*\*–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ:\*\*/)) {
                    currentSession.recovery = line.replace(/^\*\*–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ:\*\*\s*/, '').trim();
                } else if (line.match(/^\*\*–í–µ—Å:\*\*/)) {
                    currentSession.weight = line.replace(/^\*\*–í–µ—Å:\*\*\s*/, '').trim();
                } else if (line.match(/^####\s+(–°–æ—Å—Ç–æ—è–Ω–∏–µ|–í—ã–ø–æ–ª–Ω–µ–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞|–û—Å–Ω–æ–≤–Ω—ã–µ –æ—â—É—â–µ–Ω–∏—è|–ß—Ç–æ —Å—Ä–∞–±–æ—Ç–∞–ª–æ|–î–µ–π—Å—Ç–≤–∏—è —Ç—Ä–µ–Ω–µ—Ä–∞)/)) {
                    currentSection = line.replace(/^####\s+/, '').replace(/:$/, '').toLowerCase();
                } else if (line.match(/^###\s+(–í—ã–ø–æ–ª–Ω–µ–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞|–ö–ª—é—á–µ–≤—ã–µ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è|–î–µ–π—Å—Ç–≤–∏—è —Ç—Ä–µ–Ω–µ—Ä–∞)/)) {
                    currentSection = line.replace(/^###\s+/, '').replace(/:$/, '').toLowerCase();
                } else if (currentSection === '–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞' && line.trim() && !line.startsWith('**')) {
                    if (line.startsWith('-') || line.startsWith('*') || line.match(/^\d+\./)) {
                        currentSession.work.push(line.trim());
                    }
                } else if ((currentSection === '–æ—Å–Ω–æ–≤–Ω—ã–µ –æ—â—É—â–µ–Ω–∏—è' || currentSection === '—á—Ç–æ —Å—Ä–∞–±–æ—Ç–∞–ª–æ') && line.trim()) {
                    if (line.startsWith('-') || line.match(/^\d+\./)) {
                        currentSession.notes.push(line.replace(/^[-*]\s*/, '').replace(/^\d+\.\s*/, '').trim());
                    }
                }
            }
            
            // Add last session
            if (currentSession && currentSession.date) {
                progressSessions.push(currentSession);
            }
            
            // Sort by date (newest first)
            progressSessions.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            console.log('Parsed progress sessions:', progressSessions.length);
        }
        
        function filterExercises() {
            const searchTerm = document.getElementById('exerciseSearch').value.toLowerCase();
            const categories = document.querySelectorAll('.exercise-category');
            
            if (!searchTerm) {
                // Show all
                categories.forEach(cat => cat.style.display = 'block');
                document.querySelectorAll('.exercise-card').forEach(card => card.style.display = 'block');
                return;
            }
            
            categories.forEach(category => {
                const exercises = category.querySelectorAll('.exercise-card');
                let hasVisibleExercise = false;
                
                exercises.forEach(exercise => {
                    const name = exercise.dataset.name;
                    if (name.includes(searchTerm)) {
                        exercise.style.display = 'block';
                        hasVisibleExercise = true;
                    } else {
                        exercise.style.display = 'none';
                    }
                });
                
                category.style.display = hasVisibleExercise ? 'block' : 'none';
            });
        }
        
        // ==================== SETTINGS ====================
        function loadSettings() {
            const token = localStorage.getItem('github_token');
            const gistId = localStorage.getItem('gist_id');
            console.log('loadSettings:', { hasToken: !!token, gistId });
            if (token) document.getElementById('githubToken').value = token;
            if (gistId) document.getElementById('gistId').value = gistId;
        }

        async function saveSettings() {
            const token = document.getElementById('githubToken').value.trim();
            const gistId = document.getElementById('gistId').value.trim();
            
            console.log('saveSettings called:', { hasToken: !!token, gistId });
            
            if (token) {
                localStorage.setItem('github_token', token);
                console.log('Token saved to localStorage');
            }
            if (gistId) {
                localStorage.setItem('gist_id', gistId);
                console.log('GistId saved to localStorage');
            }
            
            // Verify save
            console.log('Verification:', {
                savedToken: !!localStorage.getItem('github_token'),
                savedGistId: localStorage.getItem('gist_id')
            });
            
            // updateConnectionStatus();  // Disabled: using progress_log.md now
            closeSettings();
            showToast('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!', 'success');
            
            // Load data from Gist after saving settings
            // Disabled: using progress_log.md now
            // if (token && gistId) {
            //     await loadGistData();
            //     showToast('–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ Gist', 'success');
            // }
        }

        function openSettings() {
            document.getElementById('settingsModal').classList.remove('section-hidden');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.add('section-hidden');
        }

        function updateConnectionStatus() {
            const token = localStorage.getItem('github_token');
            const gistId = localStorage.getItem('gist_id');
            const statusEl = document.getElementById('connectionStatus');
            
            if (token && gistId) {
                statusEl.className = 'mb-4 p-3 rounded-xl text-sm flex items-center gap-2 bg-green-50 text-green-700';
                statusEl.innerHTML = `
                    <span>‚úÖ</span>
                    <span>–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ GitHub Gist</span>
                    <span class="ml-auto text-xs text-green-500">${gistId.slice(0, 8)}...</span>
                `;
            } else {
                statusEl.className = 'mb-4 p-3 rounded-xl text-sm flex items-center gap-2 bg-yellow-50 text-yellow-700';
                statusEl.innerHTML = `
                    <span class="pulse">‚ö†Ô∏è</span>
                    <span>–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ GitHub Gist</span>
                    <button onclick="openSettings()" class="ml-auto btn-secondary text-xs">–ù–∞—Å—Ç—Ä–æ–∏—Ç—å</button>
                `;
            }
        }

        async function testConnection() {
            const token = document.getElementById('githubToken').value.trim();
            const gistId = document.getElementById('gistId').value.trim();
            const resultEl = document.getElementById('connectionResult');
            
            if (!token) {
                resultEl.className = 'p-3 rounded-xl text-sm bg-red-50 text-red-700';
                resultEl.textContent = '‚ùå –í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω';
                resultEl.classList.remove('hidden');
                return;
            }
            
            try {
                resultEl.className = 'p-3 rounded-xl text-sm bg-blue-50 text-blue-700';
                resultEl.textContent = '‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞...';
                resultEl.classList.remove('hidden');
                
                if (gistId) {
                    // Test existing gist
                    const res = await fetch(`https://api.github.com/gists/${gistId}`, {
                        headers: { 'Authorization': `token ${token}` }
                    });
                    
                    if (res.ok) {
                        const data = await res.json();
                        resultEl.className = 'p-3 rounded-xl text-sm bg-green-50 text-green-700';
                        resultEl.textContent = `‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ! –§–∞–π–ª–æ–≤ –≤ Gist: ${Object.keys(data.files).length}`;
                    } else {
                        throw new Error('Gist not found');
                    }
                } else {
                    // Test token only
                    const res = await fetch('https://api.github.com/user', {
                        headers: { 'Authorization': `token ${token}` }
                    });
                    
                    if (res.ok) {
                        const user = await res.json();
                        resultEl.className = 'p-3 rounded-xl text-sm bg-green-50 text-green-700';
                        resultEl.textContent = `‚úÖ –¢–æ–∫–µ–Ω –≤–∞–ª–∏–¥–Ω—ã–π! –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${user.login}`;
                    } else {
                        throw new Error('Invalid token');
                    }
                }
            } catch (e) {
                resultEl.className = 'p-3 rounded-xl text-sm bg-red-50 text-red-700';
                resultEl.textContent = `‚ùå –û—à–∏–±–∫–∞: ${e.message}`;
            }
        }

        async function createNewGist() {
            const token = document.getElementById('githubToken').value.trim();
            
            if (!token) {
                showToast('–°–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω', 'error');
                return;
            }
            
            try {
                const initialData = {
                    sessions: [],
                    created: new Date().toISOString(),
                    version: '1.0'
                };
                
                const res = await fetch('https://api.github.com/gists', {
                    method: 'POST',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        description: 'Climbing Coach - Training Data',
                        public: false,
                        files: {
                            'training_data.json': {
                                content: JSON.stringify(initialData, null, 2)
                            }
                        }
                    })
                });
                
                if (res.ok) {
                    const data = await res.json();
                    document.getElementById('gistId').value = data.id;
                    showToast(`Gist —Å–æ–∑–¥–∞–Ω! ID: ${data.id}`, 'success');
                } else {
                    throw new Error('Failed to create gist');
                }
            } catch (e) {
                showToast(`–û—à–∏–±–∫–∞: ${e.message}`, 'error');
            }
        }

        // ==================== GIST DATA ====================
        async function loadGistData() {
            const token = localStorage.getItem('github_token');
            const gistId = localStorage.getItem('gist_id');
            
            console.log('Loading Gist data...', { hasToken: !!token, gistId });
            
            if (!token || !gistId) return;
            
            try {
                const res = await fetch(`https://api.github.com/gists/${gistId}`, {
                    headers: { 'Authorization': `token ${token}` }
                });
                
                if (res.ok) {
                    const data = await res.json();
                    const content = data.files['training_data.json']?.content;
                    if (content) {
                        gistData = JSON.parse(content);
                        console.log('Gist data loaded:', gistData);
                    }
                } else {
                    console.error('Failed to load gist:', res.status, await res.text());
                }
            } catch (e) {
                console.error('Error loading gist:', e);
            }
            
            // Ensure sessions array exists
            if (!gistData.sessions) {
                gistData.sessions = [];
            }
        }

        async function saveToGist(newSession) {
            const token = localStorage.getItem('github_token');
            const gistId = localStorage.getItem('gist_id');
            
            console.log('Saving to Gist...', { hasToken: !!token, gistId });
            
            if (!token || !gistId) {
                showToast('–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Gist', 'error');
                return false;
            }
            
            // Ensure sessions array exists
            if (!gistData.sessions) {
                gistData.sessions = [];
            }
            
            try {
                gistData.sessions.unshift(newSession);
                gistData.lastUpdated = new Date().toISOString();
                
                const payload = {
                    files: {
                        'training_data.json': {
                            content: JSON.stringify(gistData, null, 2)
                        }
                    }
                };
                
                console.log('Sending payload:', payload);
                
                const res = await fetch(`https://api.github.com/gists/${gistId}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                if (res.ok) {
                    console.log('Save successful!');
                    return true;
                } else {
                    const errorText = await res.text();
                    console.error('Save failed:', res.status, errorText);
                    showToast(`–û—à–∏–±–∫–∞ ${res.status}: ${errorText.slice(0, 100)}`, 'error');
                    // Remove the session we just added since save failed
                    gistData.sessions.shift();
                    return false;
                }
            } catch (e) {
                console.error('Error saving to gist:', e);
                showToast(`–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${e.message}`, 'error');
                // Remove the session we just added since save failed
                gistData.sessions.shift();
                return false;
            }
        }

        // ==================== PROBLEMS ====================
        function addProblem(grade = '6B', attempts = 1, sent = false) {
            const id = Date.now();
            workoutData.problems.push({ id, grade, attempts, sent });
            renderProblems();
        }

        function removeProblem(id) {
            workoutData.problems = workoutData.problems.filter(p => p.id !== id);
            renderProblems();
        }

        function updateProblem(id, field, value) {
            const problem = workoutData.problems.find(p => p.id === id);
            if (problem) {
                problem[field] = value;
                renderProblems();
            }
        }

        function toggleProblemSent(id) {
            const problem = workoutData.problems.find(p => p.id === id);
            if (problem) {
                problem.sent = !problem.sent;
                renderProblems();
            }
        }

        function renderProblems() {
            const container = document.getElementById('problemsList');
            
            if (workoutData.problems.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-6 text-gray-400">
                        <p>–ù–∞–∂–º–∏—Ç–µ "+ –ü—Ä–æ–±–ª–µ–º–∞" —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å</p>
                    </div>
                `;
            } else {
                container.innerHTML = workoutData.problems.map((p, index) => `
                    <div class="problem-row">
                        <span class="text-gray-400 font-medium w-6">${index + 1}</span>
                        <select onchange="updateProblem(${p.id}, 'grade', this.value)" class="select-field">
                            ${grades.map(g => `<option value="${g}" ${p.grade === g ? 'selected' : ''}>${g}</option>`).join('')}
                        </select>
                        <select onchange="updateProblem(${p.id}, 'attempts', parseInt(this.value))" class="select-field">
                            ${[1,2,3,4,5,6,7,8,9,10].map(n => `<option value="${n}" ${p.attempts === n ? 'selected' : ''}>${n} –ø–æ–ø.</option>`).join('')}
                        </select>
                        <button onclick="toggleProblemSent(${p.id})" class="checkbox-btn ${p.sent ? 'checked' : ''}">
                            ${p.sent ? '‚úì' : ''}
                        </button>
                        <span class="text-sm ${p.sent ? 'text-green-600' : 'text-gray-400'}">
                            ${p.sent ? (p.attempts === 1 ? '–§–ª–µ—à!' : '–ü—Ä–æ–ª–µ–∑') : '–ù–µ –ø—Ä–æ–ª–µ–∑'}
                        </span>
                        <button onclick="removeProblem(${p.id})" class="ml-auto text-gray-400 hover:text-red-500">‚úï</button>
                    </div>
                `).join('');
            }
            
            // Update stats
            const total = workoutData.problems.length;
            const sent = workoutData.problems.filter(p => p.sent).length;
            const flash = workoutData.problems.filter(p => p.sent && p.attempts === 1).length;
            const flashRate = total > 0 ? Math.round((flash / total) * 100) : 0;
            
            document.getElementById('problemsStats').textContent = 
                `–ü—Ä–æ–ª–µ–∑–µ–Ω–æ: ${sent}/${total} | –§–ª–µ—à: ${flash} (${flashRate}%)`;
        }

        // ==================== EXERCISES ====================
        function addExercise(name = '', sets = 3, reps = '', weight = '', time = '') {
            const id = Date.now();
            workoutData.exercises.push({ id, name, sets, reps, weight, time, completed: [] });
            renderExercises();
        }

        function removeExercise(id) {
            workoutData.exercises = workoutData.exercises.filter(e => e.id !== id);
            renderExercises();
        }

        function updateExercise(id, field, value) {
            const exercise = workoutData.exercises.find(e => e.id === id);
            if (exercise) {
                exercise[field] = value;
                renderExercises();
            }
        }

        function toggleExerciseSet(id, setIndex) {
            const exercise = workoutData.exercises.find(e => e.id === id);
            if (exercise) {
                if (!exercise.completed) exercise.completed = [];
                const idx = exercise.completed.indexOf(setIndex);
                if (idx > -1) {
                    exercise.completed.splice(idx, 1);
                } else {
                    exercise.completed.push(setIndex);
                }
                renderExercises();
            }
        }

        function renderExercises() {
            const container = document.getElementById('exercisesList');
            
            if (workoutData.exercises.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4 text-gray-400 text-sm">
                        <p>–î–æ–±–∞–≤—å—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ –±—ã–ª–æ –≤ –ø–ª–∞–Ω–µ</p>
                    </div>
                `;
            } else {
                container.innerHTML = workoutData.exercises.map(ex => `
                    <div class="exercise-card">
                        <div class="flex flex-wrap gap-2 items-center mb-3">
                            <input type="text" value="${ex.name}" 
                                onchange="updateExercise(${ex.id}, 'name', this.value)"
                                class="input-field flex-1 min-w-[150px]" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è">
                            <button onclick="removeExercise(${ex.id})" class="text-gray-400 hover:text-red-500 px-2">‚úï</button>
                        </div>
                        <div class="flex flex-wrap gap-2 items-center mb-3">
                            <div class="flex items-center gap-1">
                                <input type="number" value="${ex.sets}" 
                                    onchange="updateExercise(${ex.id}, 'sets', parseInt(this.value))"
                                    class="input-field w-16 text-center" min="1" max="10">
                                <span class="text-gray-500 text-sm">–ø–æ–¥—Ö.</span>
                            </div>
                            <div class="flex items-center gap-1">
                                <input type="text" value="${ex.reps}" 
                                    onchange="updateExercise(${ex.id}, 'reps', this.value)"
                                    class="input-field w-16 text-center" placeholder="–ø–æ–≤—Ç.">
                                <span class="text-gray-500 text-sm">–ø–æ–≤—Ç.</span>
                            </div>
                            <div class="flex items-center gap-1">
                                <input type="text" value="${ex.weight}" 
                                    onchange="updateExercise(${ex.id}, 'weight', this.value)"
                                    class="input-field w-20 text-center" placeholder="+35–∫–≥">
                            </div>
                            <div class="flex items-center gap-1">
                                <input type="text" value="${ex.time}" 
                                    onchange="updateExercise(${ex.id}, 'time', this.value)"
                                    class="input-field w-16 text-center" placeholder="—Å–µ–∫">
                                <span class="text-gray-500 text-sm">—Å–µ–∫</span>
                            </div>
                        </div>
                        <div class="flex gap-2 flex-wrap">
                            ${Array.from({length: ex.sets}, (_, i) => `
                                <button onclick="toggleExerciseSet(${ex.id}, ${i})" 
                                    class="checkbox-btn ${ex.completed?.includes(i) ? 'checked' : ''}">
                                    ${ex.completed?.includes(i) ? '‚úì' : i + 1}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `).join('');
            }
        }

        // Plan blocks state
        let planBlocks = [];
        
        function setupDefaultExercises() {
            // Don't add default exercises anymore - plan is shown separately
            // Just render the plan
            renderTodayPlanBlocks();
        }
        
        function getCurrentDayKey() {
            if (selectedDayKey) return selectedDayKey;
            return dayKeys[new Date().getDay()];
        }
        
        function selectDay(dayKey) {
            selectedDayKey = dayKey;
            planBlocks = []; // Reset blocks when changing day
            renderTodayPlanBlocks();
            updateWorkoutHeader();
        }
        
        function updateWorkoutHeader() {
            const dayKey = getCurrentDayKey();
            const weekPlan = currentState?.week_plan;
            if (!weekPlan?.days?.[dayKey]) return;
            
            const dayPlan = weekPlan.days[dayKey];
            document.getElementById('workoutTitle').textContent = dayPlan.type;
            document.getElementById('dayIcon').textContent = dayPlan.emoji || 'üìã';
            document.getElementById('workoutDate').textContent = dayPlan.date;
        }
        
        // Render plan from week_plan (–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã)
        function renderTodayPlanBlocks() {
            const container = document.getElementById('todayPlanBlocks');
            
            if (!currentState) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–ª–∞–Ω–∞...</p>';
                setTimeout(renderTodayPlanBlocks, 500);
                return;
            }
            
            const weekPlan = currentState.week_plan;
            if (!weekPlan || !weekPlan.days) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">week_plan –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ current_state.json</p>';
                return;
            }
            
            const currentDayKey = getCurrentDayKey();
            const todayKey = dayKeys[new Date().getDay()];
            const dayPlan = weekPlan.days[currentDayKey];
            
            if (!dayPlan || !dayPlan.blocks || dayPlan.blocks.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">–ü–ª–∞–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è —ç—Ç–æ–≥–æ –¥–Ω—è</p>';
                return;
            }
            
            console.log('Rendering plan for:', currentDayKey, dayPlan.type);
            
            // Week day selector
            const daySelectorHtml = `
                <div class="mb-4 flex flex-wrap gap-2">
                    ${Object.keys(weekPlan.days).map(dayKey => {
                        const day = weekPlan.days[dayKey];
                        const isSelected = dayKey === currentDayKey;
                        const isToday = dayKey === todayKey;
                        return `
                            <button onclick="selectDay('${dayKey}')" 
                                class="flex flex-col items-center px-3 py-2 rounded-xl text-sm transition-all
                                    ${isSelected ? 'bg-purple-600 text-white' : 'bg-gray-100 hover:bg-gray-200 text-gray-700'}
                                    ${isToday && !isSelected ? 'ring-2 ring-purple-400' : ''}">
                                <span class="font-medium">${dayLabels[dayKey]}</span>
                                <span class="text-lg">${day.emoji}</span>
                            </button>
                        `;
                    }).join('')}
                </div>
                ${currentDayKey !== todayKey ? `
                    <div class="mb-3 p-2 bg-yellow-50 rounded-lg text-sm text-yellow-700">
                        ‚ö†Ô∏è –ü—Ä–æ—Å–º–æ—Ç—Ä –ø–ª–∞–Ω–∞ –Ω–∞ –¥—Ä—É–≥–æ–π –¥–µ–Ω—å. <button onclick="selectDay(null)" class="underline">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–µ–≥–æ–¥–Ω—è</button>
                    </div>
                ` : ''}
            `;
            
            // Header with plan info
            const headerHtml = `
                <div class="mb-4 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl">
                    <div class="flex items-center gap-3 mb-2">
                        <span class="text-3xl">${dayPlan.emoji || 'üìã'}</span>
                        <div>
                            <h3 class="font-bold text-lg text-gray-800">${dayPlan.type}</h3>
                            <p class="text-sm text-gray-600">
                                ${dayPlan.duration_min} –º–∏–Ω ‚Ä¢ RPE ${dayPlan.target_rpe} ‚Ä¢ ${dayPlan.location || '—Å–∫–∞–ª–æ–¥—Ä–æ–º'}
                            </p>
                        </div>
                    </div>
                    ${dayPlan.key_focus ? `<p class="text-sm text-blue-700 mt-2">üéØ <strong>–§–æ–∫—É—Å:</strong> ${dayPlan.key_focus}</p>` : ''}
                    ${dayPlan.notes ? `<p class="text-sm text-gray-500 mt-1">üìù ${dayPlan.notes}</p>` : ''}
                </div>
            `;
            
            // Variations block (if available)
            let variationsHtml = '';
            if (dayPlan.variations && (dayPlan.variations.easier || dayPlan.variations.harder)) {
                variationsHtml = '<div class="mb-4 space-y-2">';
                
                if (dayPlan.variations.easier) {
                    variationsHtml += `
                        <details class="bg-blue-50 rounded-xl border border-blue-200">
                            <summary class="p-3 pr-10 cursor-pointer hover:bg-blue-100 rounded-xl font-medium text-blue-800 flex items-center gap-2">
                                <span>üîΩ –û–±–ª–µ–≥—á–∏—Ç—å</span>
                                <span class="text-xs text-blue-600">(${dayPlan.variations.easier.when})</span>
                            </summary>
                            <div class="px-4 pb-3 text-sm text-gray-700">
                                <ul class="space-y-1 mt-2">
                                    ${dayPlan.variations.easier.changes.map(change => 
                                        `<li class="flex items-start gap-2"><span class="text-blue-500">‚Ä¢</span><span>${makeExerciseClickable(change)}</span></li>`
                                    ).join('')}
                                </ul>
                            </div>
                        </details>
                    `;
                }
                
                if (dayPlan.variations.harder) {
                    variationsHtml += `
                        <details class="bg-orange-50 rounded-xl border border-orange-200">
                            <summary class="p-3 pr-10 cursor-pointer hover:bg-orange-100 rounded-xl font-medium text-orange-800 flex items-center gap-2">
                                <span>üîº –£—Å–ª–æ–∂–Ω–∏—Ç—å</span>
                                <span class="text-xs text-orange-600">(${dayPlan.variations.harder.when})</span>
                            </summary>
                            <div class="px-4 pb-3 text-sm text-gray-700">
                                <ul class="space-y-1 mt-2">
                                    ${dayPlan.variations.harder.changes.map(change => 
                                        `<li class="flex items-start gap-2"><span class="text-orange-500">‚Ä¢</span><span>${makeExerciseClickable(change)}</span></li>`
                                    ).join('')}
                                </ul>
                            </div>
                        </details>
                    `;
                }
                
                variationsHtml += '</div>';
            }
            
            // Build plan blocks (preserve done/notes if already set for this day)
            if (planBlocks.length === 0) {
                planBlocks = dayPlan.blocks.map((block, idx) => ({
                    id: (idx + 1).toString(),
                    title: `${block.name} (${block.duration_min} –º–∏–Ω)`,
                    content: block.exercises ? block.exercises.join('\n‚Ä¢ ') : '',
                    exercises: block.exercises || [],
                    done: false,
                    notes: ''
                }));
            }
            
            // Render blocks
            const blocksHtml = planBlocks.map((block, idx) => `
                <div class="p-4 rounded-xl border ${block.done ? 'bg-green-50 border-green-200' : 'bg-gray-50 border-gray-200'}" id="planBlock${idx}">
                    <div class="flex items-start gap-3">
                        <button onclick="togglePlanBlock(${idx})" class="checkbox-btn flex-shrink-0 mt-1 ${block.done ? 'checked' : ''}">
                            ${block.done ? '‚úì' : idx + 1}
                        </button>
                        <div class="flex-1 min-w-0">
                            <div class="font-semibold text-gray-800 ${block.done ? 'line-through text-gray-500' : ''}">${block.title}</div>
                            <ul class="text-sm text-gray-600 mt-2 space-y-1">
                                ${block.exercises.map(ex => `<li class="flex items-start gap-2"><span class="text-gray-400">‚Ä¢</span>${makeExerciseClickable(ex)}</li>`).join('')}
                            </ul>
                            <div class="mt-3">
                                <input type="text" placeholder="–ó–∞–º–µ—Ç–∫–∏ –∫ –±–ª–æ–∫—É..." 
                                        class="input-field text-sm py-2"
                                        onchange="updatePlanBlockNotes(${idx}, this.value)"
                                        value="${block.notes || ''}">
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Evening priority reminder
            const eveningHtml = dayPlan.evening_priority ? `
                <div class="mt-4 p-3 bg-purple-50 rounded-xl text-sm">
                    <span class="text-purple-700">üåô <strong>–í–µ—á–µ—Ä:</strong> ${dayPlan.evening_priority}</span>
                </div>
            ` : '';
            
            // Combine day selector, header, variations, blocks, and evening
            container.innerHTML = daySelectorHtml + headerHtml + variationsHtml + blocksHtml + eveningHtml;
            
            updatePlanProgress();
        }
        
        function togglePlanBlock(idx) {
            if (planBlocks[idx]) {
                planBlocks[idx].done = !planBlocks[idx].done;
                
                // Update just this block's UI without full re-render
                const blockEl = document.getElementById(`planBlock${idx}`);
                if (blockEl) {
                    const block = planBlocks[idx];
                    blockEl.className = `p-4 rounded-xl border ${block.done ? 'bg-green-50 border-green-200' : 'bg-gray-50 border-gray-200'}`;
                    
                    const btn = blockEl.querySelector('.checkbox-btn');
                    if (btn) {
                        btn.className = `checkbox-btn flex-shrink-0 mt-1 ${block.done ? 'checked' : ''}`;
                        btn.textContent = block.done ? '‚úì' : idx + 1;
                    }
                    
                    const titleEl = blockEl.querySelector('.font-semibold');
                    if (titleEl) {
                        titleEl.className = `font-semibold text-gray-800 ${block.done ? 'line-through text-gray-500' : ''}`;
                    }
                }
                
                updatePlanProgress();
            }
        }
        
        function updatePlanBlockNotes(idx, notes) {
            if (planBlocks[idx]) {
                planBlocks[idx].notes = notes;
            }
        }
        
        function updatePlanProgress() {
            const done = planBlocks.filter(b => b.done).length;
            const total = planBlocks.length;
            document.getElementById('planProgress').textContent = `${done} / ${total} –≤—ã–ø–æ–ª–Ω–µ–Ω–æ`;
        }

        // ==================== TIMER ====================
        function setTimer(seconds) {
            timerSeconds = seconds;
            updateTimerDisplay();
        }

        function toggleTimer() {
            if (timerRunning) {
                stopTimer();
            } else {
                startTimer();
            }
        }

        function startTimer() {
            timerRunning = true;
            document.getElementById('timerBtn').textContent = '‚è∏ –ü–∞—É–∑–∞';
            document.getElementById('timerBtn').classList.add('bg-orange-500');
            
            timerInterval = setInterval(() => {
                timerSeconds--;
                updateTimerDisplay();
                
                if (timerSeconds <= 0) {
                    stopTimer();
                    playAlarm();
                    showToast('‚è∞ –í—Ä–µ–º—è –æ—Ç–¥—ã—Ö–∞ –∑–∞–∫–æ–Ω—á–∏–ª–æ—Å—å!', 'success');
                }
            }, 1000);
        }

        function stopTimer() {
            timerRunning = false;
            clearInterval(timerInterval);
            document.getElementById('timerBtn').textContent = '‚ñ∂ –°—Ç–∞—Ä—Ç';
            document.getElementById('timerBtn').classList.remove('bg-orange-500');
        }

        function updateTimerDisplay() {
            const mins = Math.floor(timerSeconds / 60);
            const secs = timerSeconds % 60;
            document.getElementById('timerDisplay').textContent = 
                `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function playAlarm() {
            // Simple beep using Web Audio API
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.frequency.value = 800;
                gain.gain.value = 0.3;
                osc.start();
                setTimeout(() => osc.stop(), 500);
            } catch (e) {}
        }

        // ==================== SAVE WORKOUT ====================
        async function saveWorkout() {
            const saveBtn = document.getElementById('saveBtn');
            saveBtn.disabled = true;
            saveBtn.textContent = '‚è≥ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
            
            const session = {
                id: Date.now(),
                date: new Date().toISOString().split('T')[0],
                dayOfWeek: new Date().getDay(),
                dayType: dayConfig[new Date().getDay()].name,
                
                preWorkout: {
                    feeling: parseInt(document.getElementById('preFeeling').value) || null,
                    sleepHours: parseFloat(document.getElementById('sleepHours').value) || null,
                    sleepQuality: parseInt(document.getElementById('sleepQuality').value) || null,
                    startTime: document.getElementById('startTime').value || null
                },
                
                // Plan blocks completion
                planBlocks: planBlocks.map(b => ({
                    title: b.title,
                    done: b.done,
                    notes: b.notes || ''
                })),
                
                // Climbing problems
                problems: workoutData.problems.map(p => ({
                    grade: p.grade,
                    attempts: p.attempts,
                    sent: p.sent
                })),
                
                // Additional exercises (not in plan)
                additionalExercises: workoutData.exercises.map(e => ({
                    name: e.name,
                    sets: e.sets,
                    reps: e.reps,
                    weight: e.weight,
                    time: e.time,
                    completedSets: e.completed?.length || 0
                })),
                
                summary: {
                    rpe: parseInt(document.getElementById('workoutRPE').value) || null,
                    duration: parseInt(document.getElementById('workoutDuration').value) || null,
                    notes: document.getElementById('workoutNotes').value.trim()
                },
                
                stats: {
                    planBlocksTotal: planBlocks.length,
                    planBlocksDone: planBlocks.filter(b => b.done).length,
                    totalProblems: workoutData.problems.length,
                    sentProblems: workoutData.problems.filter(p => p.sent).length,
                    flashCount: workoutData.problems.filter(p => p.sent && p.attempts === 1).length
                }
            };
            
            const success = await saveToGist(session);
            
            if (success) {
                showToast('‚úÖ –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!', 'success');
                // Don't clear, user might want to add more
            } else {
                showToast('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
            }
            
            saveBtn.disabled = false;
            saveBtn.textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É';
        }

        function clearWorkout() {
            if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏?')) {
                workoutData = { problems: [], exercises: [] };
                // Reset plan blocks
                planBlocks.forEach(b => {
                    b.done = false;
                    b.notes = '';
                });
                document.getElementById('preFeeling').value = '';
                document.getElementById('sleepHours').value = '';
                document.getElementById('sleepQuality').value = '';
                document.getElementById('workoutRPE').value = '';
                document.getElementById('workoutDuration').value = '';
                document.getElementById('workoutNotes').value = '';
                renderProblems();
                renderExercises();
                renderTodayPlanBlocks();
                showToast('–î–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã', 'success');
            }
        }

        // ==================== HISTORY & DASHBOARD ====================
        function renderHistory() {
            const container = document.getElementById('historyList');
            
            if (!progressSessions || progressSessions.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</p>';
                return;
            }
            
            container.innerHTML = progressSessions.map((s, index) => `
                <div class="p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition-colors">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <div class="font-bold text-gray-800">${s.type || '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞'}</div>
                            <div class="text-sm text-gray-500">${formatDate(s.date)}</div>
                        </div>
                        <div class="flex gap-2 items-center flex-wrap justify-end">
                            ${s.rpe ? `<span class="px-2 py-1 bg-purple-100 text-purple-700 rounded-lg text-sm">RPE ${s.rpe}</span>` : ''}
                            ${s.duration ? `<span class="px-2 py-1 bg-blue-100 text-blue-700 rounded-lg text-sm">${s.duration}</span>` : ''}
                            ${s.feeling ? `<span class="px-2 py-1 bg-yellow-100 text-yellow-700 rounded-lg text-sm">üé≠ ${s.feeling}</span>` : ''}
                        </div>
                    </div>
                    
                    ${s.sleep || s.recovery || s.weight ? `
                        <div class="flex flex-wrap gap-2 text-xs text-gray-600 mb-2 pb-2 border-b border-gray-200">
                            ${s.sleep ? `<span>üí§ ${s.sleep}</span>` : ''}
                            ${s.recovery ? `<span>‚ôªÔ∏è ${s.recovery}</span>` : ''}
                            ${s.weight ? `<span>‚öñÔ∏è ${s.weight}</span>` : ''}
                        </div>
                    ` : ''}
                    
                    ${s.work && s.work.length > 0 ? `
                        <details class="mb-2">
                            <summary class="cursor-pointer text-sm font-medium text-gray-700 hover:text-gray-900 mb-1">
                                üìã –í—ã–ø–æ–ª–Ω–µ–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞ (${s.work.length} –ø—É–Ω–∫—Ç–æ–≤)
                            </summary>
                            <div class="text-xs text-gray-600 bg-white p-2 rounded-lg mt-1 space-y-1">
                                ${s.work.slice(0, 10).map(w => `<div>${w}</div>`).join('')}
                                ${s.work.length > 10 ? `<div class="text-gray-400 italic">...–∏ –µ—â–µ ${s.work.length - 10}</div>` : ''}
                            </div>
                        </details>
                    ` : ''}
                    
                    ${s.notes && s.notes.length > 0 ? `
                        <div class="text-sm text-gray-700 bg-green-50 p-2 rounded-lg border border-green-200">
                            <div class="font-medium text-green-800 mb-1">üí° –ö–ª—é—á–µ–≤—ã–µ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è:</div>
                            ${s.notes.slice(0, 3).map(n => `<div class="text-xs">‚Ä¢ ${n}</div>`).join('')}
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }
        
        // History is now read-only from progress_log.md
        // No delete functionality needed

        function renderDashboard() {
            // Update total sessions from progress_log.md
            document.getElementById('totalSessions').textContent = progressSessions?.length || 0;
            
            // Update metrics from currentState if available
            if (currentState) {
                const metrics = currentState.current_metrics;
                const cycle = currentState.training_cycle;
                const recovery = currentState.recovery_status;
                
                // Update quick stats
                if (metrics) {
                    document.getElementById('currentGrade').textContent = metrics.grade || '?';
                    document.getElementById('hangTime').textContent = `${metrics.hangboard_20mm_max_hang_seconds || 0}—Å`;
                    document.getElementById('pullupWeight').textContent = `+${metrics.pullups_max_weight_kg || 0}–∫–≥`;
                }
                
                // Update cycle info
                if (cycle) {
                    document.getElementById('currentWeek').textContent = 
                        `–ù–µ–¥–µ–ª—è ${cycle.current_week} –∏–∑ ${cycle.mesocycle_length_weeks} ‚Ä¢ –§–∞–∑–∞: ${cycle.phase}`;
                    document.getElementById('mesocycleName').textContent = 
                        cycle.mesocycle_name || `–ú–µ–∑–æ—Ü–∏–∫–ª ${cycle.mesocycle}`;
                }
                
                // Show recovery status with color coding
                if (recovery) {
                    const level = recovery.overall;
                    const colorClass = level >= 7 ? 'text-green-600' : level >= 5 ? 'text-yellow-600' : 'text-red-600';
                    const fatigueIcon = recovery.accumulated_fatigue === 'HIGH' ? ' ‚ö†Ô∏è' : '';
                    document.getElementById('recoveryStatus').innerHTML = 
                        `<span class="${colorClass}">${level}/10${fatigueIcon}</span>`;
                }
            }
            
            // Render recent sessions from progress_log.md
            const container = document.getElementById('recentSessions');
            const recent = (progressSessions || []).slice(0, 3);
            
            if (recent.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">–ù–µ—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</p>';
            } else {
                container.innerHTML = recent.map(s => `
                    <div class="p-3 bg-gray-50 rounded-xl hover:bg-gray-100 transition-colors">
                        <div class="flex justify-between items-center">
                            <div>
                                <div class="font-medium text-gray-800">${s.type || '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞'}</div>
                                <div class="text-xs text-gray-500">${formatDate(s.date)}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-sm font-medium text-purple-600">RPE ${s.rpe || '-'}</div>
                                <div class="text-xs text-gray-500">${s.duration || '-'}</div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }

        async function loadHistory() {
            // await loadGistData();  // Disabled: using progress_log.md now
            renderHistory();
            showToast('–ò—Å—Ç–æ—Ä–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –∏–∑ progress_log.md', 'success');
        }

        // ==================== PLAN MODAL ====================
        function loadTodayPlan() {
            console.log('loadTodayPlan called, currentState loaded:', !!currentState);
            
            const modal = document.getElementById('planModal');
            const contentEl = document.getElementById('todayPlanContent');
            
            const weekPlan = currentState?.week_plan;
            if (!weekPlan?.days) {
                contentEl.innerHTML = '<p class="text-gray-500">–ü–ª–∞–Ω –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è... –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.</p>';
                modal.classList.remove('section-hidden');
                loadMarkdownFiles().then(() => {
                    if (currentState?.week_plan?.days) {
                        loadTodayPlan();
                    }
                });
                return;
            }
            
            const currentDayKey = getCurrentDayKey();
            const plan = weekPlan.days[currentDayKey];
            
            if (!plan) {
                contentEl.innerHTML = '<p class="text-gray-500">–ü–ª–∞–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è —ç—Ç–æ–≥–æ –¥–Ω—è</p>';
                modal.classList.remove('section-hidden');
                return;
            }
            
            // Render full plan in modal
            let html = `
                <div class="mb-4">
                    <h3 class="text-xl font-bold flex items-center gap-2">
                        <span>${plan.emoji || 'üìã'}</span>
                        ${plan.type}
                    </h3>
                    <p class="text-sm text-gray-600 mt-1">
                        ${plan.duration_min} –º–∏–Ω ‚Ä¢ RPE ${plan.target_rpe} ‚Ä¢ ${plan.location || '—Å–∫–∞–ª–æ–¥—Ä–æ–º'}
                    </p>
                    ${plan.key_focus ? `<p class="text-blue-600 mt-2">üéØ ${plan.key_focus}</p>` : ''}
                    ${plan.notes ? `<p class="text-gray-500 mt-1 text-sm">üìù ${plan.notes}</p>` : ''}
                </div>
            `;
            
            if (plan.blocks && plan.blocks.length > 0) {
                html += '<div class="space-y-4">';
                plan.blocks.forEach((block, idx) => {
                    html += `
                        <div class="p-3 bg-gray-50 rounded-xl">
                            <h4 class="font-semibold">${idx + 1}. ${block.name} (${block.duration_min} –º–∏–Ω)</h4>
                            <ul class="mt-2 text-sm text-gray-700 space-y-1">
                                ${(block.exercises || []).map(ex => `<li>‚Ä¢ ${ex}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            if (plan.evening_priority) {
                html += `<div class="mt-4 p-3 bg-purple-50 rounded-xl text-purple-700">üåô <strong>–í–µ—á–µ—Ä:</strong> ${plan.evening_priority}</div>`;
            }
            
            contentEl.innerHTML = html;
            modal.classList.remove('section-hidden');
        }

        function closePlanModal() {
            document.getElementById('planModal').classList.add('section-hidden');
        }

        // ==================== UTILITIES ====================
        function formatDate(dateStr) {
            return new Date(dateStr).toLocaleDateString('ru-RU', {
                day: 'numeric', month: 'long', year: 'numeric'
            });
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            
            setTimeout(() => toast.remove(), 3000);
        }

        function exportData() {
            const dataStr = JSON.stringify(gistData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `climbing_data_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('–î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã', 'success');
        }

        // Close modals on outside click
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                e.target.classList.add('section-hidden');
            }
        });
    </script>
</body>
</html>
